ida 6.8
f5 aparece un decmpiler de c sobre cualquier funcion
muchas cosas se sacan sin ver codigo

intenta conectarse a un servidor de control c2
no se ve el intercambio de infomracion
se conecta solo para enviarla
va a fallar porque falla la consulta dns
con wireshark se ve esta consulta
no se llega a resolver
si se resuelve y le da una ip se conecta y empieza a mandar datos

el codigo hace cambios en el sistema y intercambio de informacion, eso se ve con process monitor y burp, wireshark, proxy de sistema

se ve la consulta dns fallida
la podemos forzar para que funcione
determinamos el hostname y metemos una entrada modificando el hostname que apunte a una ip que controlemos nosotros
y ahi vemos trafico http
es analisis dinamico(no vemos codigo)

a nivel de sistema cifra los archivos
sabemos como persiste?
cambios en las entradas de registro
crea un par de llaves a nivel de usuario y maquina
que pasa si se borran?
reiniciamos y sigue corriendo?
cuales son las llaves y los registros?

cuando cifra añade una instruccion .crisis y deja un mensaje que se comuniquen con un mail
milarreta.com que se yo
dalai lama y goldmain y aol

ese tipo de cosas tambien tienen que estar

objetivo y procedimiento

googlear los mails
subir skanda a virustotal a ver que tira u otros

con el hostname podemos hacer un par de cosas tb

ayudarse con olidbg oli debugger
olly

direccion 408cc2
send_data_to_c2
vemos el hostname en olly
avtomoika234.cc

nslookup
avtomoika234.cc
cant find

virustotal
avtomoika
se encuentra maliciosa en 366
se pone la url arriba y busca mejor
se ve que antes resolvia a otras ip
y se ven archivos a donde intenta llegar skanda
versiones del ejecutable
todas cosas que ya fueron analizadas
el dominio esta dado de baja

o en vez de hacer eso se trackea el dns request

en clase resolvimos los nombres de las funciones

409100 start

40912c encrypted

decription toma cada dword en base a la posicion y hace un xor contra dos keys
esto lo hace pq no las importa directamente
para tener las funciones

luego resolve_functions va guardando en una tabla de punteros, hay que renombrarlos
y ahora podemos ver donde se esta utilizando xon las xreferences crossrefs

hay una funcion sola que envia data con send y recieve

gethostbyname es otra funcion de la tabla de punteros
si buscamos la definicion vemos que recibe un char de nombre y devuelve una estructura hosten
obtiene la ip, hace un connect, un recieve y cierra el socket

resolvemos las funiones iniciales y vamos de las interesantes hacia atras

o podemos ir secuencialmente, todo depende del tiempo que tengamos, otro lo haria con wireshark

hay que ir a la parte que descifra las funciones, desciframos y ahi vamos viendo todo

se aloca mucha memoria y se copia otra que esta cifrada

se usa l misma key apara decription, esto podemos usar en un script de python para descifrarlas

descifrando tenemos muchos strings como las extensiones soportadas
buscar todas las funciones que desencriptan cosas

4092b1
pregunta si el proceso es privilegiado y sino
intenta obtener el maximo privilegio

4092d2 rutina de persistencia
si no tiene permiso de administrador no puede mover y lo pone en otra direccion y en base a eso modifica distinta clase de registros

la que le sigue a persistencia crea otro proceso CreateProcess
si googleamos vemos que recibe el nombre de la aplicacion y otros parametros, y el chabon lo crea y mapea la entrada y saida para que no sea estandar sino a un pipe CreatePipe

y ahi le manda comandos (tambien esta encriptado
esto se ve con el process monitor
que se crea el proceso y se llama a scmd.exe
elimina todos los backups con vssadmin
y no podes hacer restore
esto se saca con process monitor
pq se ve un nuevo proceso cmd.exe y eso ejecuta el vssadmin
solo que ahi si se ejecuta el codigo

despues viene la parte que maneja los archivos y cifra

hasta ahi ya sabemos muchas cosas para el informe

lo ultimo seria ver si el modo de encripcion se puede volver hacia atras

para ver si se puede desencriptar
40966c
y 9696

con la y se puede renombrar los parametros
con n solo el nombre

tambien se pueden crear tipos y se agregan al subsistema de tipos de ida
localtypes insert se copia y ok y snincronizamos
ahi ya podemos asignar ese tipo a los parametros

409140 ejemplo de desencriptacion

si sabemos que hace una funcion pero no queremos ver exactamente el codigo ponemos un breakpoint y la debugueamos

copiamos el ollydbg y corremos el skanda ahi
409100 es el start
f8 para step over
al lado vemos los registros abajo derecha el stack
y izquierda el dump de memoria
con f8 vamos avanzando encontramos algunos ascii y en edx aparece un string, sii le damos dump vemos todos los strings
ahora pasa a resolver y poner en la tabla de punteros

si no entendemos alguna anotamos la direccion lac copiamos en dl dbg y ponemos un breakpoint
cuando el codigo llega ahi vemos el input y el output

responder preguntas, ayudarse de virustotal, etc
ver si ya hay un analisis de skanda
crysis ransomware es el nombre real

ya hay analisis en internet
de pandasecurity por ejemplpo
usar eso eso de base

para ejecutar los scripts de python
idapython
ida trae una consola de python
output window
ida tiene su api para programar

si sabemos donde empieza y cuanto ocupa la memoria cifrada hacemos una funcion que desencripte todo
g_encrypted_mem = get_many_bytes
xrefto quien llama a la funcion

como grabar rutinas?
se copia la funcion entera en la consola

kike ya le agrego un comentario a cada funcion que decripta para ir sabiendo que es cada cosa todo el tiempo
buscar tema dark del ida

hay funciones raras para generar entropia
solo nos importa el output




